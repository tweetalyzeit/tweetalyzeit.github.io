let resp = [];
let timestamps = [];
let units = [];

let chart_type = "bar";
let line_mode = "lines";
let line_shape = "linear";
let x_axis_data = [];
let y_axis_data = [];

function generateFunction(){
    const Url='https://tweetgettimestamps.herokuapp.com/?pw=newSreel' + '&user=' + $('#user').val() + '&replies=1&search=';
    $.ajax({
        url: Url,
        type:"GET",
        beforeSend: function(){
            console.log(Url)
            $('#submitHandle').attr("disabled",true);
            $('#submitHandle').html("BRB..");  
        },
        success: function(responseText){
            console.log(responseText)
            resp = responseText;

            var d = new Date();
            d.setTime(Date.now());
            var d2 = d.toUTCString();
            $('#SentNumbers').html("Generated by Tweetalyze<br>" + d2 + "<br>Username: " + resp.name + "  |  Sample Size: " + resp.sampleSize); 
            
            units = [];
            for(var i = 0; i < responseText.sampleSize; i++){
                units.push(i);
            }
            timestamps = resp.dates.reverse();
            x_axis_data = timestamps;
            y_axis_data = resp.trend_likes;

            trendTheData();
            $('#submitHandle').html("Done!");
            $('#submitHandle').attr("disabled",false);
            $('#submitHandle').html("More");  
        },
        error:function(error){
            console.log("Error")
            $('#submitHandle').html("Oops!");
        }
    })
}


function setChartType(type){
    chart_type = type;
    if(chart_type == "line"){
        document.getElementById('LineSettings').style.display = 'block';
    }
    else{
        document.getElementById('LineSettings').style.display = 'none';
        document.getElementById('Line_LineSettings').style.display = 'none';
    }
    trendTheData();
}
function setLineMode(mode){
    line_mode = mode;
    if(line_mode == "lines" || line_mode == "lines+markers"){
        document.getElementById('Line_LineSettings').style.display = 'block';
    }
    else{
        document.getElementById('Line_LineSettings').style.display = 'none';
    }
    trendTheData();
}
function setLineShape(shape){
    line_shape = shape;
    trendTheData();
}
function setXData(metric){
    switch(metric){
        case "time": x_axis_data = timestamps; break;
        case "unitless": x_axis_data = units; break;
        default: x_axis_data = timestamps; break;
    }
    trendTheData();
}
function setYData(metric){
    switch(metric){
        case "likes": y_axis_data = resp.trend_likes; break;
        case "retweets": y_axis_data = resp.trend_retweets; break;
        case "sentiment": y_axis_data = resp.trend_sentiment_score; break;
        default: y_axis_data = resp.trend_likes; break;
    }
    trendTheData();
}

function trendTheData() {
    //graph the trends
    $("#TrendLine").html('');

    var trace1 = {
        type: chart_type,
        x: x_axis_data,
        y: y_axis_data,
        name: "Sentiment Score",
        mode: line_mode,
        line: {
            color: 'rgb(29, 161, 242)',
            shape: line_shape,
            //dash: 'dash',
        }
    };

    var dataTrend = [trace1];

    var configTrend = {
        modeBarButtonsToRemove: ['zoom2d', 'pan2d', 'select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'resetScale2d', 'hoverClosestGl2d', 'hoverClosestPie','toggleHover', 'resetViews', 'sendDataToCloud', 'toggleSpikelines', 'resetViewMapbox','hoverClosestCartesian', 'hoverCompareCartesian'], 
        displaylogo: false,
        responsive: true
    };
    var layoutTrend = {
        yaxis: {
            
        },
        xaxis: {
            //showticklabels: false,
            zeroline: false,
            showline: false
        },
        legend: {
            "orientation": "v",
            x: 0.5,
            y: 1.27
        },
        images: [
            {
              x: 0,
              y: 1.1,
              sizex: 0.2,
              sizey: 0.2,
              source: resp.profilePicURL,
              xanchor: "middle",
              xref: "paper",
              yanchor: "bottom",
              yref: "paper"
            }
          ]
    };

    Plotly.newPlot("TrendLine", dataTrend, layoutTrend, configTrend);
}